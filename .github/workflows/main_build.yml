name: Master Build Android 13

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Execute Master Override (One File to Rule All)
        run: |
          # 1. Prepare clean workspace
          mkdir -p temp_java/com/example/tvosmaster
          
          # 2. Consolidate all code into ONE folder (Stops Redeclaration errors)
          cp -rn app/src/main/java/com/example/tvfloatingwidget/* temp_java/com/example/tvosmaster/ || true
          cp -rn app/src/main/java/com/example/tvosmaster/* temp_java/com/example/tvosmaster/ || true
          
          # 3. Delete the old messy structure
          rm -rf app/src/main/java/com/example/*
          
          # 4. Move the clean Master folder back in
          mv temp_java/com/example/tvosmaster app/src/main/java/com/example/
          
          # 5. Rewrite file identities to match tvosmaster
          find app/src/main/java -name "*.kt" -exec sed -i 's/package com.example.*/package com.example.tvosmaster/g' {} +
          find app/src/main/java -name "*.kt" -exec sed -i 's/import com.example.*.R/import com.example.tvosmaster.R/g' {} +
          
          # 6. Fix Android 13 Manifest Structure
          sed -i 's/package="com.example.[^"]*"//g' app/src/main/AndroidManifest.xml

      - name: Generate APK
        run: |
          chmod +x gradlew
          ./gradlew assembleDebug --stacktrace

      - name: Upload Resulting APK
        uses: actions/upload-artifact@v4
        with:
          name: Final-TVOS-Master-APK
          path: app/build/outputs/apk/debug/*.apk
