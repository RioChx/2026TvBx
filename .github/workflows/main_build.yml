name: Master Build Android 13 (Final 100% Fix)

on:
  push:
    branches: [ "main", "Clean-Project-Structure" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Master Project Override
        run: |
          # 1. FIX FOLDER CONFLICTS (Eliminates Redeclaration Errors)
          # Moves all logic into 'tvosmaster' and wipes 'tvfloatingwidget'
          mkdir -p temp_java/com/example/tvosmaster
          cp -rn app/src/main/java/com/example/tvfloatingwidget/* temp_java/com/example/tvosmaster/ || true
          cp -rn app/src/main/java/com/example/tvosmaster/* temp_java/com/example/tvosmaster/ || true
          rm -rf app/src/main/java/com/example/*
          mv temp_java/com/example/tvosmaster app/src/main/java/com/example/
          
          # 2. ALIGN PACKAGE NAMES (Fixes Import Errors)
          find app/src/main/java -name "*.kt" -exec sed -i 's/package com.example.*/package com.example.tvosmaster/g' {} +
          find app/src/main/java -name "*.kt" -exec sed -i 's/import com.example.*.R/import com.example.tvosmaster.R/g' {} +
          
          # 3. RESOURCE INJECTION (Fixes 'Unresolved reference' Errors)
          mkdir -p app/src/main/res/drawable
          mkdir -p app/src/main/res/values

          # Create IDs for the compiler
          cat <<EOF > app/src/main/res/values/ids.xml
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <item type="id" name="hand_hour" /><item type="id" name="hand_minute" />
              <item type="id" name="hand_second" /><item type="id" name="controls_ribbon" />
          </resources>
          EOF

          # Inject XML Assets provided by the user
          cat <<EOF > app/src/main/res/drawable/hand_hour.xml
          <vector xmlns:android="http://schemas.android.com/apk/res/android" android:width="120dp" android:height="120dp" android:viewportWidth="120" android:viewportHeight="120"><path android:fillColor="#00E5FF" android:pathData="M58,35h4v25h-4z" /></vector>
          EOF
          cat <<EOF > app/src/main/res/drawable/hand_minute.xml
          <vector xmlns:android="http://schemas.android.com/apk/res/android" android:width="120dp" android:height="120dp" android:viewportWidth="120" android:viewportHeight="120"><path android:fillColor="#E6FFFFFF" android:pathData="M59,20h2v40h-2z" /></vector>
          EOF
          cat <<EOF > app/src/main/res/drawable/hand_second.xml
          <vector xmlns:android="http://schemas.android.com/apk/res/android" android:width="120dp" android:height="120dp" android:viewportWidth="120" android:viewportHeight="120"><path android:fillColor="#FF3D00" android:pathData="M59.5,15h1v45h-1z" /></vector>
          EOF
          cat <<EOF > app/src/main/res/drawable/controls_ribbon.xml
          <vector xmlns:android="http://schemas.android.com/apk/res/android" android:width="200dp" android:height="4dp" android:viewportWidth="200" android:viewportHeight="4"><path android:fillColor="#4000E5FF" android:pathData="M0,0h200v4h-200z" /></vector>
          EOF
          cat <<EOF > app/src/main/res/drawable/artistic_glass_panel.xml
          <shape xmlns:android="http://schemas.android.com/apk/res/android"><solid android:color="#F2080808" /><corners android:radius="40dp" /><stroke android:width="1dp" android:color="#25FFFFFF" /></shape>
          EOF
          cat <<EOF > app/src/main/res/drawable/analog_clock_frame.xml
          <shape xmlns:android="http://schemas.android.com/apk/res/android" android:shape="oval"><solid android:color="#15FFFFFF" /><stroke android:width="2dp" android:color="#00E5FF" /></shape>
          EOF
          cat <<EOF > app/src/main/res/drawable/artistic_btn_bg.xml
          <ripple xmlns:android="http://schemas.android.com/apk/res/android" android:color="#40FFFFFF"><item><shape><solid android:color="#15FFFFFF" /><corners android:radius="18dp" /></shape></item></ripple>
          EOF

          # 4. RUNTIME FIX (Fixes the White Page/Overlay Permission)
          # Injects the Overlay Permission request into MainActivity.kt
          sed -i '/onCreate/a \    if (!android.provider.Settings.canDrawOverlays(this)) { \
              val intent = android.content.Intent(android.provider.Settings.ACTION_MANAGE_OVERLAY_PERMISSION) \
              startActivity(intent) \
          }' app/src/main/java/com/example/tvosmaster/MainActivity.kt

          # 5. MANIFEST CLEANUP
          sed -i 's/package="com.example.[^"]*"//g' app/src/main/AndroidManifest.xml
          # Add Foreground Service Type for Android 13
          sed -i '/<service/s/>/ android:foregroundServiceType="specialUse" >/' app/src/main/AndroidManifest.xml

      - name: Build APK
        run: |
          chmod +x gradlew
          ./gradlew assembleDebug --stacktrace

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Final-TV-Widget-APK
          path: app/build/outputs/apk/debug/*.apk
