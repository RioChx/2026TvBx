name: Ultimate Master Build (No-Crash Version)

on:
  push:
    branches: [ "main", "Clean-Project-Structure" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Master Project Override
        run: |
          # 1. CLEANING AND REORGANIZING
          mkdir -p app/src/main/java/com/example/tvosmaster
          mkdir -p app/src/main/res/drawable
          mkdir -p app/src/main/res/layout
          mkdir -p app/src/main/res/values
          rm -rf app/src/main/java/com/example/tvfloatingwidget

          # 2. INJECTING ALL XML ASSETS
          cat <<EOF > app/src/main/res/drawable/hand_hour.xml
          <vector xmlns:android="http://schemas.android.com/apk/res/android" android:width="120dp" android:height="120dp" android:viewportWidth="120" android:viewportHeight="120"><path android:fillColor="#00E5FF" android:pathData="M58,35h4v25h-4z" /></vector>
          EOF
          cat <<EOF > app/src/main/res/drawable/hand_minute.xml
          <vector xmlns:android="http://schemas.android.com/apk/res/android" android:width="120dp" android:height="120dp" android:viewportWidth="120" android:viewportHeight="120"><path android:fillColor="#E6FFFFFF" android:pathData="M59,20h2v40h-2z" /></vector>
          EOF
          cat <<EOF > app/src/main/res/drawable/hand_second.xml
          <vector xmlns:android="http://schemas.android.com/apk/res/android" android:width="120dp" android:height="120dp" android:viewportWidth="120" android:viewportHeight="120"><path android:fillColor="#FF3D00" android:pathData="M59.5,15h1v45h-1z" /></vector>
          EOF
          cat <<EOF > app/src/main/res/drawable/controls_ribbon.xml
          <vector xmlns:android="http://schemas.android.com/apk/res/android" android:width="200dp" android:height="4dp" android:viewportWidth="200" android:viewportHeight="4"><path android:fillColor="#4000E5FF" android:pathData="M0,0h200v4h-200z" /></vector>
          EOF
          cat <<EOF > app/src/main/res/drawable/artistic_glass_panel.xml
          <shape xmlns:android="http://schemas.android.com/apk/res/android"><solid android:color="#F2080808" /><corners android:radius="40dp" /><stroke android:width="1dp" android:color="#25FFFFFF" /></shape>
          EOF
          cat <<EOF > app/src/main/res/drawable/analog_clock_frame.xml
          <shape xmlns:android="http://schemas.android.com/apk/res/android" android:shape="oval"><solid android:color="#15FFFFFF" /><stroke android:width="2dp" android:color="#00E5FF" /></shape>
          EOF
          cat <<EOF > app/src/main/res/drawable/artistic_btn_bg.xml
          <ripple xmlns:android="http://schemas.android.com/apk/res/android" android:color="#40FFFFFF"><item><shape><solid android:color="#15FFFFFF" /><corners android:radius="18dp" /></shape></item></ripple>
          EOF

          # 3. LAYOUT INJECTION (Fixes crashing from missing UI)
          cat <<EOF > app/src/main/res/layout/activity_main.xml
          <?xml version="1.0" encoding="utf-8"?>
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android" android:layout_width="match_parent" android:layout_height="match_parent" android:orientation="vertical" android:gravity="center" android:background="#121212">
              <Button android:id="@+id/btnStart" android:layout_width="wrap_content" android:layout_height="wrap_content" android:text="START CLOCK" android:backgroundTint="#00E5FF" android:textColor="#000000" />
          </LinearLayout>
          EOF

          cat <<EOF > app/src/main/res/layout/widget_layout.xml
          <?xml version="1.0" encoding="utf-8"?>
          <FrameLayout xmlns:android="http://schemas.android.com/apk/res/android" android:layout_width="wrap_content" android:layout_height="wrap_content" android:background="@drawable/artistic_glass_panel">
              <ImageView android:layout_width="150dp" android:layout_height="150dp" android:src="@drawable/analog_clock_frame" />
              <ImageView android:id="@+id/hand_hour" android:layout_width="150dp" android:layout_height="150dp" android:src="@drawable/hand_hour" />
              <ImageView android:id="@+id/hand_minute" android:layout_width="150dp" android:layout_height="150dp" android:src="@drawable/hand_minute" />
              <ImageView android:id="@+id/hand_second" android:layout_width="150dp" android:layout_height="150dp" android:src="@drawable/hand_second" />
          </FrameLayout>
          EOF

          # 4. MANIFEST OVERWRITE (The Safety Net)
          cat <<EOF > app/src/main/AndroidManifest.xml
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android" package="com.example.tvosmaster">
              <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
              <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE_SPECIAL_USE" />
              <application android:label="TV Master Clock" android:theme="@style/Theme.AppCompat.NoActionBar">
                  <activity android:name=".MainActivity" android:exported="true">
                      <intent-filter><action android:name="android.intent.action.MAIN" /><category android:name="android.intent.category.LAUNCHER" /></intent-filter>
                  </activity>
                  <service android:name=".FloatingWidgetService" android:foregroundServiceType="specialUse" android:exported="false" />
              </application>
          </manifest>
          EOF

          # 5. KOTLIN CODE INJECTION (Anti-Crash Logic)
          cat <<EOF > app/src/main/java/com/example/tvosmaster/MainActivity.kt
          package com.example.tvosmaster
          import android.os.*
          import android.content.Intent
          import android.provider.Settings
          import android.widget.Button
          import androidx.appcompat.app.AppCompatActivity
          import androidx.core.app.ActivityCompat
          import android.Manifest

          class MainActivity : AppCompatActivity() {
              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  setContentView(R.layout.activity_main)
                  if (Build.VERSION.SDK_INT >= 33) ActivityCompat.requestPermissions(this, arrayOf(Manifest.permission.POST_NOTIFICATIONS), 1)
                  findViewById<Button>(R.id.btnStart).setOnClickListener {
                      if (!Settings.canDrawOverlays(this)) {
                          startActivity(Intent(Settings.ACTION_MANAGE_OVERLAY_PERMISSION))
                      } else {
                          val intent = Intent(this, FloatingWidgetService::class.java)
                          if (Build.VERSION.SDK_INT >= 26) startForegroundService(intent) else startService(intent)
                      }
                  }
              }
          }
          EOF

          cat <<EOF > app/src/main/java/com/example/tvosmaster/FloatingWidgetService.kt
          package com.example.tvosmaster
          import android.app.*
          import android.content.*
          import android.graphics.PixelFormat
          import android.os.*
          import android.view.*
          import android.widget.ImageView
          import androidx.core.app.NotificationCompat
          import java.util.*

          class FloatingWidgetService : Service() {
              private lateinit var windowManager: WindowManager
              private lateinit var floatingView: View

              override fun onBind(intent: Intent?): IBinder? = null

              override fun onCreate() {
                  super.onCreate()
                  createNotificationChannel()
                  val notification = NotificationCompat.Builder(this, "clock_channel")
                      .setContentTitle("TV Clock Active").setSmallIcon(android.R.drawable.ic_lock_idle_alarm).build()
                  startForeground(1, notification)

                  windowManager = getSystemService(WINDOW_SERVICE) as WindowManager
                  floatingView = LayoutInflater.from(this).inflate(R.layout.widget_layout, null)

                  val params = WindowManager.LayoutParams(
                      WindowManager.LayoutParams.WRAP_CONTENT, WindowManager.LayoutParams.WRAP_CONTENT,
                      if (Build.VERSION.SDK_INT >= 26) WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY else WindowManager.LayoutParams.TYPE_PHONE,
                      WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE, PixelFormat.TRANSLUCENT
                  )
                  windowManager.addView(floatingView, params)
                  startClock()
              }

              private fun startClock() {
                  val handler = Handler(Looper.getMainLooper())
                  handler.post(object : Runnable {
                      override fun run() {
                          val calendar = Calendar.getInstance()
                          floatingView.findViewById<ImageView>(R.id.hand_hour).rotation = (calendar.get(Calendar.HOUR) * 30 + calendar.get(Calendar.MINUTE) / 2).toFloat()
                          floatingView.findViewById<ImageView>(R.id.hand_minute).rotation = (calendar.get(Calendar.MINUTE) * 6).toFloat()
                          floatingView.findViewById<ImageView>(R.id.hand_second).rotation = (calendar.get(Calendar.SECOND) * 6).toFloat()
                          handler.postDelayed(this, 1000)
                      }
                  })
              }

              private fun createNotificationChannel() {
                  if (Build.VERSION.SDK_INT >= 26) {
                      val channel = NotificationChannel("clock_channel", "Clock Service", NotificationManager.IMPORTANCE_LOW)
                      (getSystemService(NOTIFICATION_SERVICE) as NotificationManager).createNotificationChannel(channel)
                  }
              }

              override fun onDestroy() {
                  super.onDestroy()
                  if (::floatingView.isInitialized) windowManager.removeView(floatingView)
              }
          }
          EOF

      - name: Build APK
        run: |
          chmod +x gradlew
          ./gradlew assembleDebug --stacktrace

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Final-TV-Master-Clock
          path: app/build/outputs/apk/debug/*.apk
